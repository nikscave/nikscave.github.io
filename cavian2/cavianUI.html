<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cavian 2.0</title>
  
  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  
  <!-- Modular CSS -->
  <link rel="stylesheet" href="/themes/theme.css">
  <link rel="stylesheet" href="/css/cavianUI.css">
  
  <!-- Theme Switcher -->
  <script src="/js/theme-switcher.js" defer></script>
  
  <style>
    .status-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      color: #64c8ff;
      padding: 8px 16px;
      font-size: 14px;
      z-index: 1000;
      text-align: center;
    }
    .status-bar.demo {
      background: rgba(255, 165, 0, 0.9);
      color: #000;
    }
  </style>
</head>
<body>
  <!-- Status Bar -->
  <div id="statusBar" class="status-bar demo">üéÆ Demo Mode - Connect to device for live control</div>

  <!-- Top Bar -->
  <div id="topBar">
    <button class="view-button active" id="btn-vertical" onclick="switchView('vertical')">SEQ</button>
    <button class="view-button" id="btn-8x8" onclick="switchView('horizontal')">8√ó8</button>
    <button class="view-button" id="btn-64" onclick="switchView('horizontal64')">64</button>
    <button class="view-button" id="btn-swing" onclick="switchView('swing')">SWING</button>
    <button class="view-button" id="btn-mute" onclick="switchView('actions')">ACTIONS</button>
  </div>

  <!-- Main Layout -->
  <div id="mainLayout">
    <!-- BPM Control -->
    <div id="bpmColumn">
      <label>BPM</label>
      <input type="range" id="bpmInput" min="1" max="400" value="120">
      <div id="bpmDisplay">120</div>
    </div>

    <!-- Grid Area -->
    <div id="gridArea">
      <!-- Vertical Sequencer -->
      <div id="sequencer-container">
        <div id="sequencer"></div>
      </div>
      
      <!-- Horizontal Container -->
      <div id="horizontal-container" style="display: none;">
        <div id="horizontal-grid"></div>
      </div>
    </div>

    <!-- Control Panel -->
    <div id="controlPanel">
      <div id="controlGrid">
        <!-- Group Display -->
        <div class="control-section">
          <div class="control-label">GROUP</div>
          <div class="status-display group">
            <span class="status-text">G</span>
            <span class="status-value" id="groupDisplay">1</span>
          </div>
          <div class="control-buttons">
            <button class="control-btn up" onclick="changeGroup('up')">‚ñ≤</button>
            <button class="control-btn down" onclick="changeGroup('down')">‚ñº</button>
          </div>
        </div>

        <!-- Preset Display -->
        <div class="control-section">
          <div class="control-label">PRESET</div>
          <div class="status-display preset">
            <span class="status-text">P</span>
            <span class="status-value" id="presetDisplay">1</span>
          </div>
          <div class="control-buttons">
            <button class="control-btn up" onclick="changePreset('up')">‚ñ≤</button>
            <button class="control-btn down" onclick="changePreset('down')">‚ñº</button>
          </div>
        </div>

        <!-- Channel Display -->
        <div class="control-section">
          <div class="control-label">CHANNEL</div>
          <div class="status-display channel">
            <span class="status-text">CH</span>
            <span class="status-value" id="channelDisplay">1</span>
          </div>
          <div class="control-buttons">
            <button class="control-btn up" onclick="changeChannel('up')">‚ñ≤</button>
            <button class="control-btn down" onclick="changeChannel('down')">‚ñº</button>
          </div>
        </div>

        <!-- Tempo Display -->
        <div class="control-section">
          <div class="control-label">TEMPO</div>
          <div class="status-display tempo">
            <span class="status-text">BPM</span>
            <span class="status-value" id="tempoDisplay">120</span>
          </div>
          <div class="control-buttons">
            <button class="control-btn up" onclick="changeTempo('up')">‚ñ≤</button>
            <button class="control-btn down" onclick="changeTempo('down')">‚ñº</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Bar -->
  <div id="bottomBar">
    <div id="dualContextControls">
      <div class="left-buttons">
        <button onclick="openSettings()">‚öôÔ∏è Settings</button>
        <button onclick="openSaveModal()">üíæ Save</button>
        <button onclick="openLoadModal()">üìÇ Load</button>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div id="statusBar"></div>

  <!-- Save Modal -->
  <div id="saveModal" class="modal">
    <div class="modal-content">
      <h3>üíæ Save Pattern</h3>
      <div class="slot-selection" id="saveSlots"></div>
      <div class="save-boxes" id="saveBoxes"></div>
      <div id="nameInputContainer">
        <input type="text" id="patternName" placeholder="Pattern name (optional)">
      </div>
      <div style="margin-top: 20px; text-align: right;">
        <button onclick="closeModal()">Cancel</button>
        <button onclick="savePattern()">Save</button>
      </div>
    </div>
  </div>

  <!-- Load Modal -->
  <div id="loadModal" class="modal">
    <div class="modal-content">
      <h3>üìÇ Load Pattern</h3>
      <div class="slot-selection" id="loadSlots"></div>
      <div class="save-boxes" id="loadBoxes"></div>
      <div style="margin-top: 20px; text-align: right;">
        <button onclick="closeModal()">Cancel</button>
        <button onclick="loadPattern()">Load</button>
      </div>
    </div>
  </div>

  <!-- Swing Editor (hidden by default) -->
  <div id="swingEditor" style="display: none;">
    <!-- Swing editor content loaded via AJAX or inline -->
  </div>

  <!-- Actions Editor (hidden by default) -->
  <div id="actionsEditor" style="display: none;">
    <!-- Actions editor content -->
  </div>

  <!-- Modular JavaScript -->
  <script src="/js/utils.js"></script>
  <script src="/js/cavianUI.js"></script>
  
  <!-- Page-specific initialization -->
  <script>
    // DEMO MODE INITIALIZATION
    const DEMO_MODE = true;
    
    let caveArray = [];
    let activeGroup = 0;
    let activePreset = 0;
    let activeChannel = 0;
    let currentStep = 0;
    let bpm = 120;
    let demoInterval = null;

    function generateDemoData() {
      const demo = [];
      for (let g = 0; g < 8; g++) {
        const presets = [];
        for (let p = 0; p < 8; p++) {
          const rows = [];
          for (let ch = 0; ch < 8; ch++) {
            const steps = [];
            for (let s = 0; s < 8; s++) {
              const val = (g + p + ch + s) % 3;
              steps.push(val === 2 ? 0 : val);
            }
            rows.push(steps);
          }
          presets.push(rows);
        }
        demo.push(presets);
      }
      return demo;
    }

    function startDemoMode() {
      caveArray = generateDemoData();
      console.log('Demo mode started');
      updateStepsGrid(activeGroup, activePreset, activeChannel);
      updateDisplays();
      startStepAnimation();
    }

    function updateDisplays() {
      const gd = document.getElementById('groupDisplay');
      const pd = document.getElementById('presetDisplay');
      const cd = document.getElementById('channelDisplay');
      if (gd) gd.textContent = activeGroup + 1;
      if (pd) pd.textContent = activePreset + 1;
      if (cd) cd.textContent = activeChannel + 1;
    }

    function updateStepsGrid(group, preset, channel) {
      const sequencer = document.getElementById('sequencer');
      if (!sequencer || !caveArray.length) return;
      
      let html = '';
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const val = caveArray[group][preset][row][col] || 0;
          const isPlaying = col === currentStep;
          const classes = ['button'];
          if (val === 1) classes.push('active');
          else if (val === 9) classes.push('always-active');
          if (isPlaying) classes.push('playing');
          html += `<div class="${classes.join(' ')}" data-row="${row}" data-col="${col}" onclick="toggleCell(${row}, ${col})"></div>`;
        }
      }
      sequencer.innerHTML = html;
    }

    function toggleCell(row, col) {
      if (!caveArray.length) return;
      caveArray[activeGroup][activePreset][row][col] = 
        (caveArray[activeGroup][activePreset][row][col] + 1) % 3;
      updateStepsGrid(activeGroup, activePreset, activeChannel);
      showStatus(`Cell ${row + 1}:${col + 1} set to ${caveArray[activeGroup][activePreset][row][col]}`);
    }

    function changeGroup(dir) {
      activeGroup = (activeGroup + dir + 8) % 8;
      updateDisplays();
      updateStepsGrid(activeGroup, activePreset, activeChannel);
    }

    function changePreset(dir) {
      activePreset = (activePreset + dir + 8) % 8;
      updateDisplays();
      updateStepsGrid(activeGroup, activePreset, activeChannel);
    }

    function changeChannel(dir) {
      activeChannel = (activeChannel + dir + 8) % 8;
      updateDisplays();
      updateStepsGrid(activeGroup, activePreset, activeChannel);
    }

    function changeTempo(dir) {
      bpm = Math.max(1, Math.min(400, bpm + (dir === 'up' ? 5 : -5)));
      const bd = document.getElementById('bpmDisplay');
      const bi = document.getElementById('bpmInput');
      if (bd) bd.textContent = bpm;
      if (bi) bi.value = bpm;
      
      if (demoInterval) {
        clearInterval(demoInterval);
        demoInterval = setInterval(() => {
          currentStep = (currentStep + 1) % 8;
          updateStepsGrid(activeGroup, activePreset, activeChannel);
        }, (60000 / bpm) / 4);
      }
      showStatus(`BPM: ${bpm}`);
    }

    function startStepAnimation() {
      if (demoInterval) clearInterval(demoInterval);
      demoInterval = setInterval(() => {
        currentStep = (currentStep + 1) % 8;
        updateStepsGrid(activeGroup, activePreset, activeChannel);
      }, (60000 / bpm) / 4);
    }

    function showStatus(msg) {
      const sb = document.getElementById('statusBar');
      if (sb) {
        sb.textContent = msg;
        setTimeout(() => {
          sb.textContent = 'üéÆ Demo Mode - Connect to device for live control';
        }, 2000);
      }
    }

    function openSettings() {
      window.location.href = '/config.html';
    }

    function openSaveModal() { showStatus('Save modal (demo)'); }
    function openLoadModal() { showStatus('Load modal (demo)'); }
    function closeModal() {}

    function switchView(view) {
      document.querySelectorAll('.view-button').forEach(b => b.classList.remove('active'));
      document.getElementById('btn-' + view)?.classList.add('active');
      showStatus('Switched to ' + view + ' view');
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Cavian2 UI initializing (demo mode)');
      
      // Generate vertical grid buttons
      const sequencer = document.getElementById('sequencer');
      let html = '';
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          html += `<div class="button" data-row="${row}" data-col="${col}"></div>`;
        }
      }
      sequencer.innerHTML = html;
      
      updateDisplays();
      startDemoMode();
    });
  </script>
</body>
</html>
